--- Makefile.common.orig	2021-02-17 00:07:22 UTC
+++ Makefile.common
@@ -37,7 +37,7 @@ LIB_DEPENDS+=	libexpat.so:textproc/expat
 USES+=	xorg
 .endif
 .endif
-.if ${COMPONENT} != osmesa
+.if ${COMPONENT} != osmesa && ${COMPONENT} != osmesa-gallium
 LIB_DEPENDS+=	libdrm.so:graphics/libdrm
 .endif
 .if ${COMPONENT} != libs
@@ -47,15 +47,17 @@ LIB_DEPENDS+=	libglapi.so:graphics/mesa-
 LIB_DEPENDS+=	libunwind.so:devel/libunwind
 .endif
 .if ${OPSYS} == DragonFly
-LIB_DEPENDS+=	libelf.so:devel/libelf
 .endif
 
 USES+=		compiler:c++11-lib bison meson pathfix pkgconfig \
 		python:3.6+,build shebangfix tar:xz
 
+# all ports whine on WARNING: Gettext not found, all translation targets will be ignored.
+USES+=		gettext-tools
+
 USE_LDCONFIG=	yes
 
-.if ${/usr/bin/ld:L:tA} != /usr/bin/ld.lld
+.if exists(/usr/bin/ld.lld) && ${/usr/bin/ld:L:tA} != /usr/bin/ld.lld
 # --build-id isn't supported by old GNU ld.bfd in base
 # Also ld.bfd have problems that seems related to --as-needed
 USE_BINUTILS=		yes
@@ -101,3 +103,21 @@ RUN_DEPENDS+=	llvm${LLVM_DEFAULT}>=10.0.
 MESON_ARGS+=	--native-file="${WRKSRC}/llvm.ini"
 LDFLAGS+=	-Wl,-rpath=${LOCALBASE}/llvm${LLVM_DEFAULT}/lib
 MESON_ARGS+=	-Dllvm=enabled
+
+# On DragonFly llvm is only present in mesa-dri-gallium mesa-osmesa-gallium ports
+# to reduce overhead of having llvm/clang huge dependency for no good reason
+.if ${OPSYS} == DragonFly
+# XXX disable dri3 until ftigeot figure it out
+MESON_ARGS+=	-Ddri3=disabled
+. if ${COMPONENT} == libs || ${COMPONENT} == dri || ${COMPONENT} == osmesa
+MESON_ARGS+=	-Dllvm=disabled
+.  if defined(DEVELOPER)
+# reduces binary differences somewhat while investigating
+LDFLAGS+=	-Wl,-rpath=${LOCALBASE}/llvm${LLVM_DEFAULT}/lib
+.  endif
+. else
+LIB_DEPENDS+=	libelf.so:devel/libelf
+BUILD_DEPENDS+=	llvm${LLVM_DEFAULT}>=0:devel/llvm${LLVM_DEFAULT}
+RUN_DEPENDS+=	llvm${LLVM_DEFAULT}>=0:devel/llvm${LLVM_DEFAULT}
+. endif
+.endif
